### AGENTS.md

> _Этот документ читают в первую очередь и люди, и ИИ-агенты._

---

#### 1. Общие правила общения и стиля

- **Язык общения:** русский, деловой формат.
- **Комментарии в коде:** на русском или английском (предпочтительно русском для бизнес-логики).
- **Идентификаторы:** на латинице (snake_case для Python).
- **UI тексты (ответы бота):** строго на русском.
- Все новые задачи формируются явно и не придумываются "на лету" без запроса пользователя.

**Роли:**

- **Руководитель (user):** задаёт функциональные требования и цели.
- **ChatGPT (web):** стратегический инженер, следит за архитектурой, инвариантами и безопасностью миграций.
- **Codex (agent):** исполнитель.
    - правит только код, относящийся к текущей задаче.
    - не меняет глобальную архитектуру (например, способ хранения данных) без явных указаний.
    - не трогает "legacy" логику БД без необходимости.
    - Если install/build/test не проходит — остановись, опиши причину и предложи минимальный фикс окружения. Не делай рефакторинг.
    - Запрет на “переписывать компонент целиком”, только точечные изменения.
    - Жёсткое правило: если окружение не поднимается — код не трогать, предложить план действий.
    - Не добавлять новые зависимости.
    - Запрещено добавлять в git и включать в PR любые бинарные файлы и артефакты сборки.


---

#### 2. Состав репозитория

Проект представляет собой монолитный Telegram-бот на `aiogram 3.14.0`.

**Ключевые подсистемы:**

1. **Core (Ядро):**
    - `bot.py` — entry point (Polling).
    - `config.py` — конфигурация, секреты и инициализация объекта `Bot`.
    - `logging_module.py` — кастомная настройка логгеров (RotatinFileHandler).

2. **Data Layer (Слой данных):**
    - `database.py` — гибридное хранилище (файлы `bd.txt` + in-memory массивы).
    - `bd.txt` — "Legacy" база данных. Формат: `ID;Company;Phone`.
    - `phone.txt` — справочник контактов.

3. **Logic & Handlers (Логика):**
    - `routers/` — контроллеры (User, Admin, Events).
    - `services.py` — бизнес-логика (ACL, Anti-Flood, File operations).
    - `FSMstates.py` — состояния конечных автоматов.

4. **UI & Reporting:**
    - `keyboards.py` — билдеры клавиатур.
    - `html_export.py` — генерация HTML-журнала.

---

#### 3. Архитектурные правила (обязательно к чтению)


**Data Persistence:**
- Используется подход: **Write-Through Cache**.
- При старте `load_bd()` загружает данные в глобальные массивы.
- При записи (`input_bd`, `del_bd`) данные меняются в памяти и сразу сбрасываются в `bd.txt`.
- **Запрет:** Нельзя рефакторить `database.py` в классы/ORM без отдельной задачи "Миграция БД".

**Logging:**
- Использовать только `logging_module.py`.
- Логгер `root` пишет в `bot.log` (технические события).
- Логгер `KPP` пишет в `KPP.log` (бизнес-события для охраны).

**Dependency Injection:**
- Объект `Bot` инициализируется в `config.py`.
- Роутеры импортируют `bot` из `config.py`, чтобы избежать циклических ссылок.

---

#### 4. Наследие vs Новые фичи

- **Legacy-код:** `database.py` и формат `bd.txt` считаются "хрупким наследием".
- Любые изменения в структуре `bd.txt` (добавление колонок) требуют ручной миграции файла данных. Агент не должен менять логику парсинга (`split(';')`), если не уверен в валидности существующего файла.
- Новые фичи (новые команды, отчеты) должны реализовываться через добавление хендлеров в `routers/` и функций в `services.py`, минимизируя вмешательство в ядро `database.py`.

---

#### 5. Задачи для Codex

Все задачи поступают от пользователя в чате. При выполнении задачи Codex обязан:

1. Read `AGENTS.md` (этот файл).
2. Read `ARCHITECTURE.md`.
3. Сформировать план работ.
4. Внести изменения.
5. Убедиться, что не нарушены инварианты (например, не "съехал" ли формат файла БД).
6. Сообщить пользователю кратко summary изменений.
7. Изменения в документации(если затронута).

---

#### 6. Execution / Checks

Базовая проверка:

1. **Синтаксис:** Код валиден Python 3.13.8
2. **Импорты:** Нет циклических импортов.

---

#### 7. Частые сценарии (Cheat Sheet)

- **Добавить админскую кнопку:**
    1. `keyboards.py` -> добавить в `admKeyList`.
    2. `routers/admin.py` -> добавить `@router.callback_query`.

- **Добавить шаг регистрации:**
    1. `FSMstates.py` -> добавить состояние в класс `Form`.
    2. `routers/user.py` -> добавить хендлер состояния.
    3. `database.py` -> (ОПАСНО) если нужно хранить новое поле, требуется рефакторинг БД.

- **Изменить логирование:**
    1. Правки только в `logging_module.py`.


#### 8. В планах улучшение кода:
1. **Импорты модулей:** Проверить корректность импорта модулей в коде
