# AGENTS.md

> **Внимание ИИ:** Этот файл содержит жесткие правила для изменения этого проекта. Прочтите его перед генерацией любого кода.

## 1. Краткий обзор проекта
Телеграм-бот для управления пропусками в Технопарке.
**Стек:** Python 3.13, `aiogram` 3.14.0.
**Хранение данных:** Кастомная файловая база данных (`bd.txt`) с кэшированием в памяти (глобальные массивы).
**Ключевая логика:** Контроль доступа через членство в группе Telegram, логирование генерации пропусков в HTML и текстовые файлы.

## 2. Структура и ключевые директории
├── bot.py # Точка входа (только поллинг)
├── config.py # Конфигурация и инстанс Бота (псевдо-синглтон)
├── database.py # КРИТИЧНО: Низкоуровневый I/O файлов и кэш в памяти
├── logging_module.py # Кастомная настройка логов (НЕ называть 'logging.py')
├── routers/ # Хендлеры бизнес-логики
│ ├── user.py # Публичные команды
│ ├── admin.py # Ограниченные команды
│ └── events.py # Обновления участников чата


## 3. Команды запуска и сборки
- **Запуск бота:** `python bot.py`
- **Зависимости:** `pip install -r requirements.txt` 
- **Тесты:** Автоматические тесты отсутствуют. 

## 4. Архитектура и паттерны
- **Фреймворк:** `aiogram` 3.14 с использованием паттерна `Router`.
- **Паттерн данных (Legacy):**
  - **Чтение:** Данные загружаются из `bd.txt` в глобальные массивы в `database.py` (`id`, `company`, `phone`).
  - **Запись:** Обновления сначала меняют массивы, затем триггерят полную перезапись `bd.txt`.
  - **Ограничение:** **НЕ рефакторить `database.py` в классы или ORM**, если это явно не запрошено. Текущая структура на глобальных массивах — жесткая зависимость легаси-кода.
- **Логирование:** Использовать `logging_module.py`. Никогда не создавать файл с именем `logging.py` (конфликт со стандартной библиотекой).

## 5. Код-стайл и конвенции
- **Язык:**
  - Код/Комментарии: Русский или Английский.
  - UI Тексты/Логи: Русский, логи Английский.
- **Импорты:** Использовать абсолютные импорты (напр. `from database import load_bd`).
- **Форматирование:** PEP 8.
- **Async/Await:** Все хендлеры должны быть асинхронными. Операции в `database.py` пока остаются синхронными (не менять этот смешанный режим без разрешения).

## 6. Безопасность и ограничения
- **Секреты:** Токены и ID хранятся в `config.py`. Никогда не хардкодить их в других файлах.
- **Критичные файлы:**
  - `bd.txt`: **НИКОГДА** не менять разделитель (`;`) или структуру заголовка вручную. Парсер очень чувствителен.

- **Запрещенные действия:**
  - Не внедрять SQLite/PostgreSQL.
  - Не закрывать сессию бота (`bot.session.close()`) вручную внутри хендлеров.
  - Не менять логику `TIME_WINDOW` в `services.py` без понимания влияния на анти-спам.

## 7. Частые задачи и воркфлоу

### Добавление новой команды пользователя
1. Определить хендлер в `routers/user.py`.
2. Добавить необходимые кнопки в `keyboards.py`.
3. Если нужен текст ответа, добавить константы в `config.py`.
4. Зарегистрировать роутер в `bot.py` (только если создается новый файл роутера).

### Добавление новой админской функции
1. Добавить кнопку в список `admKeyList` в `keyboards.py`.
2. Обработать колбэк в `routers/admin.py`.
3. Убедиться, что выполняется проверка прав (`check_members` или проверка статуса).

### Изменение структуры Базы Данных
**ВНИМАНИЕ:** Высокий риск.
1. Обновить функции `input_bd`, `load_bd` и `save_bd` в `database.py`.
2. Обновить `routers/admin.py`, где происходит распаковка данных из массивов.
3. Проверить работу функций модуля database.py
